spring:
  application:
    name: api-gateway
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      # Short timeouts: fail fast on Redis unavailability so rate limit filter falls back to in-memory
      timeout: 2s
      connect-timeout: 2s
  cloud:
    gateway:
      routes:
        - id: auth
          uri: http://localhost:8081
          predicates:
            - Path=/api/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: authCircuit
                fallbackUri: forward:/fallback/auth
          metadata:
            response-timeout: 15000
        - id: product
          uri: http://localhost:8083
          predicates:
            - Path=/api/products/**
          filters:
            - name: CircuitBreaker
              args:
                name: productCircuit
                fallbackUri: forward:/fallback/product
          metadata:
            response-timeout: 15000
        - id: inventory
          uri: http://localhost:8084
          predicates:
            - Path=/api/inventory/**
          filters:
            - name: CircuitBreaker
              args:
                name: inventoryCircuit
                fallbackUri: forward:/fallback/inventory
          metadata:
            response-timeout: 4000
        - id: cart
          uri: http://localhost:8085
          predicates:
            - Path=/api/cart/**
          filters:
            - name: CircuitBreaker
              args:
                name: cartCircuit
                fallbackUri: forward:/fallback/cart
          metadata:
            response-timeout: 4000
        - id: order
          uri: http://localhost:8086
          predicates:
            - Path=/api/orders/**
          filters:
            - name: CircuitBreaker
              args:
                name: orderCircuit
                fallbackUri: forward:/fallback/order
          metadata:
            response-timeout: 5000
        - id: payment
          uri: http://localhost:8087
          predicates:
            - Path=/api/payments/**
          filters:
            - name: CircuitBreaker
              args:
                name: paymentCircuit
                fallbackUri: forward:/fallback/payment
          metadata:
            response-timeout: 5000
        - id: search
          uri: http://localhost:8089
          predicates:
            - Path=/api/search/**
          filters:
            - name: CircuitBreaker
              args:
                name: searchCircuit
                fallbackUri: forward:/fallback/search
          metadata:
            response-timeout: 3000

server:
  port: 8080

app:
  gateway:
    api-version:
      required: v1
    rate-limit:
      # redis: try Redis first, fallback to in-memory if Redis unavailable
      # in-memory: use in-memory only (no Redis)
      mode: redis
      max-requests: 120
      window-seconds: 60
    auth:
      validate-url: http://localhost:8081/api/auth/validate
      validate-timeout-seconds: 15
  frontend-flags:
    beta-banner-enabled: true
    admin-console-enabled: false

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans

resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 20
        minimumNumberOfCalls: 10
        failureRateThreshold: 50
        slowCallRateThreshold: 60
        slowCallDurationThreshold: 2s
        permittedNumberOfCallsInHalfOpenState: 5
        waitDurationInOpenState: 20s
        automaticTransitionFromOpenToHalfOpenEnabled: true
    instances:
      authCircuit:
        baseConfig: default
      productCircuit:
        baseConfig: default
      inventoryCircuit:
        baseConfig: default
      cartCircuit:
        baseConfig: default
      orderCircuit:
        baseConfig: default
      paymentCircuit:
        baseConfig: default
      searchCircuit:
        baseConfig: default
  timelimiter:
    configs:
      default:
        timeoutDuration: 3s
        cancelRunningFuture: true
      authExtended:
        timeoutDuration: 15s
        cancelRunningFuture: true
    instances:
      authCircuit:
        baseConfig: authExtended
      productCircuit:
        baseConfig: default
      inventoryCircuit:
        baseConfig: default
      cartCircuit:
        baseConfig: default
      orderCircuit:
        baseConfig: default
      paymentCircuit:
        baseConfig: default
      searchCircuit:
        baseConfig: default

logging:
  pattern:
    level: "%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]"
