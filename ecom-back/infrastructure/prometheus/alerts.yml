groups:
  - name: saga-alerts
    rules:
      - alert: OrderSagaTimeoutSpike
        expr: increase(order_saga_timeout_total[10m]) > 3
        for: 2m
        labels:
          severity: warning
          service: order-service
        annotations:
          summary: "Order saga timeout spike"
          description: "More than 3 order timeouts detected in the last 10 minutes."

      - alert: OrderOutboxFailuresPresent
        expr: order_outbox_failed_records > 0
        for: 5m
        labels:
          severity: critical
          service: order-service
        annotations:
          summary: "Order outbox has failed records"
          description: "Order outbox failed records are above zero for at least 5 minutes."

      - alert: NotificationDeadLetterSpike
        expr: increase(notification_dead_letter_total[10m]) >= 2
        for: 3m
        labels:
          severity: warning
          service: notification-service
        annotations:
          summary: "Notification dead letters detected"
          description: "At least two notifications moved to dead letter in the last 10 minutes."

      - alert: NotificationDeadLetterCritical
        expr: increase(notification_dead_letter_total[10m]) >= 5
        for: 2m
        labels:
          severity: critical
          service: notification-service
        annotations:
          summary: "Notification dead letters are spiking"
          description: "Five or more notifications moved to dead letter in the last 10 minutes."

      - alert: NotificationDeliveryFailureRateHigh
        expr: (sum(increase(notification_failed_total[15m])) / clamp_min(sum(increase(notification_sent_total[15m]) + increase(notification_failed_total[15m])), 1)) > 0.05
        for: 5m
        labels:
          severity: warning
          service: notification-service
        annotations:
          summary: "Notification delivery failure rate is high"
          description: "Failure rate exceeded 5% in the last 15 minutes."

      - alert: PaymentProviderRetrySpike
        expr: increase(payment_provider_retry_total[10m]) >= 20
        for: 3m
        labels:
          severity: warning
          service: payment-service
        annotations:
          summary: "Payment provider retries are spiking"
          description: "Payment provider retries crossed warning threshold in the last 10 minutes."

      - alert: PaymentProviderDlqIncrease
        expr: increase(payment_provider_dlq_total[10m]) >= 1
        for: 2m
        labels:
          severity: critical
          service: payment-service
        annotations:
          summary: "Payment provider DLQ entries detected"
          description: "At least one payment intent was moved to provider DLQ in the last 10 minutes."

      - alert: PaymentProviderRequeueFailures
        expr: increase(payment_provider_requeue_total{result="failed"}[15m]) >= 2
        for: 3m
        labels:
          severity: warning
          service: payment-service
        annotations:
          summary: "Payment provider requeue failures detected"
          description: "Provider dead-letter requeue failed at least twice in the last 15 minutes."

      - alert: ReleaseGateRollbackCallbackFailuresPresent
        expr: sum(increase(release_gate_rollback_callback_failure_total[6h])) >= 1
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          component: release-gate
        annotations:
          summary: "Release gate rollback callback failures detected"
          description: "At least one rollback callback verification failure occurred in the last 6 hours."

      - alert: ReleaseGateRollbackCallbackFailureRateCritical
        expr: ((sum(increase(release_gate_rollback_callback_failure_total[24h])) / clamp_min(sum(increase(release_gate_rollback_callback_total[24h])), 1)) > 0.20) and (sum(increase(release_gate_rollback_callback_total[24h])) >= 3)
        for: 5m
        labels:
          severity: critical
          service: api-gateway
          component: release-gate
        annotations:
          summary: "Release gate rollback callback failure rate is critical"
          description: "Rollback callback failure rate exceeded 20% over 24h with at least 3 callback events."

      - alert: ReleaseGateRollbackCallbackDrillMissing
        expr: sum(increase(release_gate_rollback_callback_total[14d])) < 1
        for: 30m
        labels:
          severity: warning
          service: api-gateway
          component: release-gate
        annotations:
          summary: "Release gate rollback callback drill signal missing"
          description: "No rollback callback events were observed in the last 14 days; run a rollback drill to validate signal path."
