name: backend-release

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    tags: [ "v*" ]

concurrency:
  group: backend-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Install parent aggregator POM
        run: mvn -N -f ecom-back/pom.xml install

      - name: Build shared modules
        run: |
          mvn -f ecom-back/common/common-core/pom.xml -DskipTests install
          mvn -f ecom-back/common/common-events/pom.xml -DskipTests install
          mvn -f ecom-back/common/common-security/pom.xml -DskipTests install
          mvn -f ecom-back/common/common-web/pom.xml -DskipTests install

      - name: Quality test gate
        run: |
          run_service_tests() {
            local pom="$1"
            local report="$2"
            if ! mvn -f "$pom" test; then
              echo "Test failure for $pom"
              if [ -f "$report" ]; then
                echo "---- Surefire report: $report ----"
                cat "$report"
              fi
              exit 1
            fi
          }

          run_service_tests \
            ecom-back/services/payment-service/pom.xml \
            ecom-back/services/payment-service/target/surefire-reports/com.ecom.payment.service.PaymentServiceTest.txt
          run_service_tests \
            ecom-back/services/inventory-service/pom.xml \
            ecom-back/services/inventory-service/target/surefire-reports/com.ecom.inventory.integration.InventorySagaConsumerIntegrationTest.txt
          run_service_tests \
            ecom-back/services/search-service/pom.xml \
            ecom-back/services/search-service/target/surefire-reports/com.ecom.search.service.SearchServiceTest.txt
          run_service_tests \
            ecom-back/api-gateway/pom.xml \
            ecom-back/api-gateway/target/surefire-reports/com.ecom.gateway.filter.JwtAuthFilterTest.txt
          python ecom-back/scripts/check_search_dataset_freshness.py
          python ecom-back/scripts/check_event_contracts.py
          python ecom-back/scripts/check_api_docs.py

  package:
    runs-on: ubuntu-latest
    needs: [ quality ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build deployable artifacts
        run: mvn -f ecom-back/pom.xml -DskipTests package

      - name: Create release manifest
        run: |
          mkdir -p build-artifacts
          find ecom-back -name "*.jar" -type f -print > build-artifacts/artifacts.txt
          sha256sum $(cat build-artifacts/artifacts.txt) > build-artifacts/checksums.sha256

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-release-artifacts
          path: |
            build-artifacts/artifacts.txt
            build-artifacts/checksums.sha256
            ecom-back/**/target/*.jar

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [ package ]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    environment: staging
    env:
      # default to true when the variable isn't defined, so regular pushes don't
      # attempt to validate staging URLs.  Setting SKIP_DEPLOY=false explicitly
      # (via repo variable or workflow_dispatch input) will re-enable checks.
      SKIP_DEPLOY: ${{ vars.SKIP_DEPLOY || 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-release-artifacts
          path: build-artifacts

      - name: Validate promotion manifest
        run: |
          if [ -f build-artifacts/artifacts.txt ] && [ -f build-artifacts/checksums.sha256 ]; then
            echo "Promotion manifest found at build-artifacts/*"
          elif [ -f build-artifacts/build-artifacts/artifacts.txt ] && [ -f build-artifacts/build-artifacts/checksums.sha256 ]; then
            echo "Promotion manifest found at nested build-artifacts/build-artifacts/*; normalizing paths."
            cp build-artifacts/build-artifacts/artifacts.txt build-artifacts/artifacts.txt
            cp build-artifacts/build-artifacts/checksums.sha256 build-artifacts/checksums.sha256
          else
            echo "Promotion manifest files not found after artifact download."
            find build-artifacts -maxdepth 4 -type f -print || true
            exit 1
          fi

      - name: Check staging URLs
        if: ${{ env.SKIP_DEPLOY != 'true' }}
        run: |
          test -n "$STAGING_BROWSE_BASE_URL" || (echo "Missing STAGING_BROWSE_BASE_URL" && exit 1)
          test -n "$STAGING_CART_BASE_URL" || (echo "Missing STAGING_CART_BASE_URL" && exit 1)
          test -n "$STAGING_ORDER_BASE_URL" || (echo "Missing STAGING_ORDER_BASE_URL" && exit 1)
          test -n "$STAGING_PAYMENT_BASE_URL" || (echo "Missing STAGING_PAYMENT_BASE_URL" && exit 1)

      - name: Trigger staging deployment
        id: deploy_staging_trigger
        if: ${{ env.SKIP_DEPLOY != 'true' }}
        env:
          STAGING_DEPLOY_WEBHOOK: ${{ secrets.STAGING_DEPLOY_WEBHOOK }}
        run: |
          if [ -z "$STAGING_DEPLOY_WEBHOOK" ]; then
            echo "STAGING_DEPLOY_WEBHOOK not configured; running dry-run deployment gate."
            echo "deploy_mode=dry_run" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          curl -sS -X POST "$STAGING_DEPLOY_WEBHOOK" -H "Content-Type: application/json" -d '{"service":"ecom-backend","ref":"'"${GITHUB_REF}"'"}'
          echo "deploy_mode=live" >> "$GITHUB_OUTPUT"

      - name: Run staging smoke checks
        id: smoke_staging
        if: steps.deploy_staging_trigger.outputs.deploy_mode == 'live'
        continue-on-error: true
        env:
          SMOKE_URLS: ${{ secrets.STAGING_SMOKE_URLS }}
          SMOKE_TIMEOUT_SECONDS: 5
          SMOKE_EXPECTED_STATUS: 200
          SMOKE_BEARER_TOKEN: ${{ secrets.STAGING_SMOKE_BEARER_TOKEN }}
        run: |
          if [ -z "$SMOKE_URLS" ]; then
            echo "STAGING_SMOKE_URLS not configured; failing staging smoke gate."
            exit 1
          fi
          python ecom-back/scripts/post_deploy_smoke.py

      - name: Trigger staging rollback on smoke failure
        id: rollback_staging
        if: steps.deploy_staging_trigger.outputs.deploy_mode == 'live' && steps.smoke_staging.outcome == 'failure'
        continue-on-error: true
        env:
          ROLLBACK_WEBHOOK_URL: ${{ secrets.STAGING_ROLLBACK_WEBHOOK }}
          ROLLBACK_ENVIRONMENT: staging
          ROLLBACK_REASON: post_deploy_smoke_failed
          ROLLBACK_REF: ${{ github.ref }}
          ROLLBACK_RUN_ID: ${{ github.run_id }}
        run: |
          if [ -z "$ROLLBACK_WEBHOOK_URL" ]; then
            echo "STAGING_ROLLBACK_WEBHOOK not configured; rollback trigger skipped."
            echo "rollback_state=skipped_missing_webhook" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          python ecom-back/scripts/trigger_rollback.py
          echo "rollback_state=triggered" >> "$GITHUB_OUTPUT"

      - name: Verify staging rollback callback
        id: rollback_callback_staging
        if: steps.deploy_staging_trigger.outputs.deploy_mode == 'live' && steps.smoke_staging.outcome == 'failure'
        continue-on-error: true
        env:
          CALLBACK_WEBHOOK_URL: ${{ secrets.STAGING_ROLLBACK_VERIFY_WEBHOOK }}
          CALLBACK_METRICS_URL: ${{ secrets.STAGING_RELEASE_GATE_METRICS_URL }}
          CALLBACK_EVENT: rollback_verification
          CALLBACK_ENVIRONMENT: staging
          CALLBACK_STATUS: triggered
          CALLBACK_REF: ${{ github.ref }}
          CALLBACK_RUN_ID: ${{ github.run_id }}
          CALLBACK_DETAILS: smoke_failure_rollback_triggered
        run: |
          if [ -z "$CALLBACK_WEBHOOK_URL" ]; then
            echo "STAGING_ROLLBACK_VERIFY_WEBHOOK not configured; rollback callback verification skipped."
            echo "callback_state=skipped_missing_webhook" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          python ecom-back/scripts/post_release_gate_callback.py
          echo "callback_state=verified" >> "$GITHUB_OUTPUT"

      - name: Staging release gate summary
        if: always()
        run: |
          {
            echo "## Staging Release Gate"
            echo ""
            echo "| Check | Outcome |"
            echo "|---|---|"
            echo "| Deploy mode | ${{ steps.deploy_staging_trigger.outputs.deploy_mode || 'unknown' }} |"
            echo "| Smoke checks | ${{ steps.smoke_staging.outcome }} |"
            echo "| Rollback trigger | ${{ steps.rollback_staging.outcome || 'skipped' }} |"
            echo "| Rollback state | ${{ steps.rollback_staging.outputs.rollback_state || 'not-required' }} |"
            echo "| Rollback callback verification | ${{ steps.rollback_callback_staging.outcome || 'skipped' }} |"
            echo "| Rollback callback state | ${{ steps.rollback_callback_staging.outputs.callback_state || 'not-required' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

          mkdir -p release-gate
          cat > release-gate/staging-release-gate.json <<EOF
          {
            "environment": "staging",
            "deployMode": "${{ steps.deploy_staging_trigger.outputs.deploy_mode || 'unknown' }}",
            "smokeOutcome": "${{ steps.smoke_staging.outcome }}",
            "rollbackTriggerOutcome": "${{ steps.rollback_staging.outcome || 'skipped' }}",
            "rollbackState": "${{ steps.rollback_staging.outputs.rollback_state || 'not-required' }}",
            "rollbackCallbackOutcome": "${{ steps.rollback_callback_staging.outcome || 'skipped' }}",
            "rollbackCallbackState": "${{ steps.rollback_callback_staging.outputs.callback_state || 'not-required' }}",
            "runId": "${{ github.run_id }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload staging release gate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-release-gate-report
          path: release-gate/staging-release-gate.json

      - name: Enforce staging smoke gate
        if: steps.deploy_staging_trigger.outputs.deploy_mode == 'live' && steps.smoke_staging.outcome == 'failure'
        run: |
          echo "Staging smoke checks failed. Rollback state: ${{ steps.rollback_staging.outputs.rollback_state || 'not-required' }}."
          exit 1

  deploy-production:
    runs-on: ubuntu-latest
    needs: [ deploy-staging ]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-release-artifacts
          path: build-artifacts

      - name: Validate production promotion manifest
        run: |
          if [ -f build-artifacts/artifacts.txt ] && [ -f build-artifacts/checksums.sha256 ]; then
            echo "Production manifest found at build-artifacts/*"
          elif [ -f build-artifacts/build-artifacts/artifacts.txt ] && [ -f build-artifacts/build-artifacts/checksums.sha256 ]; then
            echo "Production manifest found at nested build-artifacts/build-artifacts/*; normalizing paths."
            cp build-artifacts/build-artifacts/artifacts.txt build-artifacts/artifacts.txt
            cp build-artifacts/build-artifacts/checksums.sha256 build-artifacts/checksums.sha256
          else
            echo "Production manifest files not found after artifact download."
            find build-artifacts -maxdepth 4 -type f -print || true
            exit 1
          fi

      - name: Trigger production deployment
        env:
          PRODUCTION_DEPLOY_WEBHOOK: ${{ secrets.PRODUCTION_DEPLOY_WEBHOOK }}
        run: |
          if [ -z "$PRODUCTION_DEPLOY_WEBHOOK" ]; then
            echo "PRODUCTION_DEPLOY_WEBHOOK not configured; refusing production deploy."
            exit 1
          fi
          curl -sS -X POST "$PRODUCTION_DEPLOY_WEBHOOK" -H "Content-Type: application/json" -d '{"service":"ecom-backend","ref":"'"${GITHUB_REF}"'"}'

      - name: Run production smoke checks
        id: smoke_production
        continue-on-error: true
        env:
          SMOKE_URLS: ${{ secrets.PRODUCTION_SMOKE_URLS }}
          SMOKE_TIMEOUT_SECONDS: 5
          SMOKE_EXPECTED_STATUS: 200
          SMOKE_BEARER_TOKEN: ${{ secrets.PRODUCTION_SMOKE_BEARER_TOKEN }}
        run: |
          if [ -z "$SMOKE_URLS" ]; then
            echo "PRODUCTION_SMOKE_URLS not configured; failing production smoke gate."
            exit 1
          fi
          python ecom-back/scripts/post_deploy_smoke.py

      - name: Trigger production rollback on smoke failure
        id: rollback_production
        if: steps.smoke_production.outcome == 'failure'
        env:
          ROLLBACK_WEBHOOK_URL: ${{ secrets.PRODUCTION_ROLLBACK_WEBHOOK }}
          ROLLBACK_ENVIRONMENT: production
          ROLLBACK_REASON: post_deploy_smoke_failed
          ROLLBACK_REF: ${{ github.ref }}
          ROLLBACK_RUN_ID: ${{ github.run_id }}
        run: |
          if [ -z "$ROLLBACK_WEBHOOK_URL" ]; then
            echo "PRODUCTION_ROLLBACK_WEBHOOK not configured; cannot auto-rollback."
            exit 1
          fi
          python ecom-back/scripts/trigger_rollback.py

      - name: Verify production rollback callback
        id: rollback_callback_production
        if: steps.smoke_production.outcome == 'failure'
        env:
          CALLBACK_WEBHOOK_URL: ${{ secrets.PRODUCTION_ROLLBACK_VERIFY_WEBHOOK }}
          CALLBACK_METRICS_URL: ${{ secrets.PRODUCTION_RELEASE_GATE_METRICS_URL }}
          CALLBACK_EVENT: rollback_verification
          CALLBACK_ENVIRONMENT: production
          CALLBACK_STATUS: triggered
          CALLBACK_REF: ${{ github.ref }}
          CALLBACK_RUN_ID: ${{ github.run_id }}
          CALLBACK_DETAILS: smoke_failure_rollback_triggered
        run: |
          if [ -z "$CALLBACK_WEBHOOK_URL" ]; then
            echo "PRODUCTION_ROLLBACK_VERIFY_WEBHOOK not configured; cannot verify rollback callback."
            exit 1
          fi
          python ecom-back/scripts/post_release_gate_callback.py

      - name: Production release gate summary
        if: always()
        run: |
          {
            echo "## Production Release Gate"
            echo ""
            echo "| Check | Outcome |"
            echo "|---|---|"
            echo "| Smoke checks | ${{ steps.smoke_production.outcome }} |"
            echo "| Rollback trigger | ${{ steps.rollback_production.outcome || 'skipped' }} |"
            echo "| Rollback callback verification | ${{ steps.rollback_callback_production.outcome || 'skipped' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

          mkdir -p release-gate
          cat > release-gate/production-release-gate.json <<EOF
          {
            "environment": "production",
            "smokeOutcome": "${{ steps.smoke_production.outcome }}",
            "rollbackTriggerOutcome": "${{ steps.rollback_production.outcome || 'skipped' }}",
            "rollbackCallbackOutcome": "${{ steps.rollback_callback_production.outcome || 'skipped' }}",
            "runId": "${{ github.run_id }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload production release gate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-release-gate-report
          path: release-gate/production-release-gate.json

      - name: Enforce production smoke gate
        if: steps.smoke_production.outcome == 'failure'
        run: |
          echo "Production smoke checks failed and rollback was triggered."
          exit 1

  load-regression:
    runs-on: ubuntu-latest
    needs: [ deploy-staging ]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate load regression target secrets
        env:
          STAGING_BROWSE_BASE_URL: ${{ secrets.STAGING_BROWSE_BASE_URL }}
          STAGING_CART_BASE_URL: ${{ secrets.STAGING_CART_BASE_URL }}
          STAGING_ORDER_BASE_URL: ${{ secrets.STAGING_ORDER_BASE_URL }}
          STAGING_PAYMENT_BASE_URL: ${{ secrets.STAGING_PAYMENT_BASE_URL }}
        run: |
          test -n "$STAGING_BROWSE_BASE_URL" || (echo "Missing STAGING_BROWSE_BASE_URL" && exit 1)
          test -n "$STAGING_CART_BASE_URL" || (echo "Missing STAGING_CART_BASE_URL" && exit 1)
          test -n "$STAGING_ORDER_BASE_URL" || (echo "Missing STAGING_ORDER_BASE_URL" && exit 1)
          test -n "$STAGING_PAYMENT_BASE_URL" || (echo "Missing STAGING_PAYMENT_BASE_URL" && exit 1)

      - name: Run browse baseline regression
        env:
          BASE_URL: ${{ secrets.STAGING_BROWSE_BASE_URL }}
          API_VERSION: v1
          VUS: 40
          ITERATIONS: 2000
          MAX_DURATION: 90s
          BROWSE_P95_MS: 180
          BROWSE_FAIL_RATE_MAX: 0.02
        run: |
          docker run --rm -i \
            -e BASE_URL \
            -e API_VERSION \
            -e VUS \
            -e ITERATIONS \
            -e MAX_DURATION \
            -e BROWSE_P95_MS \
            -e BROWSE_FAIL_RATE_MAX \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            grafana/k6 run ecom-back/load-tests/k6/browse-products.js

      - name: Run cart baseline regression
        env:
          BASE_URL: ${{ secrets.STAGING_CART_BASE_URL }}
          API_VERSION: v1
          VUS: 35
          ITERATIONS: 1800
          MAX_DURATION: 90s
          CART_P95_MS: 220
          CART_FAIL_RATE_MAX: 0.03
          CART_CONSISTENCY_MIN: 0.99
        run: |
          docker run --rm -i \
            -e BASE_URL \
            -e API_VERSION \
            -e VUS \
            -e ITERATIONS \
            -e MAX_DURATION \
            -e CART_P95_MS \
            -e CART_FAIL_RATE_MAX \
            -e CART_CONSISTENCY_MIN \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            grafana/k6 run ecom-back/load-tests/k6/cart-operations.js

      - name: Run checkout baseline regression
        env:
          ORDER_BASE_URL: ${{ secrets.STAGING_ORDER_BASE_URL }}
          PAYMENT_BASE_URL: ${{ secrets.STAGING_PAYMENT_BASE_URL }}
          API_VERSION: v1
          VUS: 25
          ITERATIONS: 1000
          MAX_DURATION: 120s
          INCLUDE_PAYMENT_INTENT: true
          CHECKOUT_P95_MS: 320
          CHECKOUT_FAIL_RATE_MAX: 0.05
          CHECKOUT_SUCCESS_MIN: 0.95
        run: |
          docker run --rm -i \
            -e ORDER_BASE_URL \
            -e PAYMENT_BASE_URL \
            -e API_VERSION \
            -e VUS \
            -e ITERATIONS \
            -e MAX_DURATION \
            -e INCLUDE_PAYMENT_INTENT \
            -e CHECKOUT_P95_MS \
            -e CHECKOUT_FAIL_RATE_MAX \
            -e CHECKOUT_SUCCESS_MIN \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            grafana/k6 run ecom-back/load-tests/k6/checkout-flow.js

      - name: Load regression summary
        if: always()
        run: |
          {
            echo "## Staging Load Regression Gate"
            echo ""
            echo "- Browse/cart/checkout k6 baselines executed."
            echo "- Thresholds are budget-enforced in each script."
          } >> "$GITHUB_STEP_SUMMARY"

  load-regression-production-read-heavy:
    runs-on: ubuntu-latest
    needs: [ deploy-production ]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate production load target secrets
        env:
          PRODUCTION_BROWSE_BASE_URL: ${{ secrets.PRODUCTION_BROWSE_BASE_URL }}
          PRODUCTION_CART_BASE_URL: ${{ secrets.PRODUCTION_CART_BASE_URL }}
          PRODUCTION_ORDER_BASE_URL: ${{ secrets.PRODUCTION_ORDER_BASE_URL }}
          PRODUCTION_PAYMENT_BASE_URL: ${{ secrets.PRODUCTION_PAYMENT_BASE_URL }}
        run: |
          test -n "$PRODUCTION_BROWSE_BASE_URL" || (echo "Missing PRODUCTION_BROWSE_BASE_URL" && exit 1)
          test -n "$PRODUCTION_CART_BASE_URL" || (echo "Missing PRODUCTION_CART_BASE_URL" && exit 1)
          test -n "$PRODUCTION_ORDER_BASE_URL" || (echo "Missing PRODUCTION_ORDER_BASE_URL" && exit 1)
          test -n "$PRODUCTION_PAYMENT_BASE_URL" || (echo "Missing PRODUCTION_PAYMENT_BASE_URL" && exit 1)

      - name: Run production browse regression (read-heavy profile)
        env:
          BASE_URL: ${{ secrets.PRODUCTION_BROWSE_BASE_URL }}
          API_VERSION: v1
          VUS: 30
          ITERATIONS: 1500
          MAX_DURATION: 120s
          BROWSE_P95_MS: 276
          BROWSE_FAIL_RATE_MAX: 0.03
        run: |
          docker run --rm -i \
            -e BASE_URL \
            -e API_VERSION \
            -e VUS \
            -e ITERATIONS \
            -e MAX_DURATION \
            -e BROWSE_P95_MS \
            -e BROWSE_FAIL_RATE_MAX \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            grafana/k6 run ecom-back/load-tests/k6/browse-products.js

      - name: Run production cart regression (read-heavy profile)
        env:
          BASE_URL: ${{ secrets.PRODUCTION_CART_BASE_URL }}
          API_VERSION: v1
          VUS: 25
          ITERATIONS: 1200
          MAX_DURATION: 120s
          CART_P95_MS: 312
          CART_FAIL_RATE_MAX: 0.04
          CART_CONSISTENCY_MIN: 0.98
        run: |
          docker run --rm -i \
            -e BASE_URL \
            -e API_VERSION \
            -e VUS \
            -e ITERATIONS \
            -e MAX_DURATION \
            -e CART_P95_MS \
            -e CART_FAIL_RATE_MAX \
            -e CART_CONSISTENCY_MIN \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            grafana/k6 run ecom-back/load-tests/k6/cart-operations.js

      - name: Run production checkout regression (conservative profile)
        env:
          ORDER_BASE_URL: ${{ secrets.PRODUCTION_ORDER_BASE_URL }}
          PAYMENT_BASE_URL: ${{ secrets.PRODUCTION_PAYMENT_BASE_URL }}
          API_VERSION: v1
          VUS: 15
          ITERATIONS: 500
          MAX_DURATION: 120s
          INCLUDE_PAYMENT_INTENT: false
          CHECKOUT_P95_MS: 432
          CHECKOUT_FAIL_RATE_MAX: 0.07
          CHECKOUT_SUCCESS_MIN: 0.90
        run: |
          docker run --rm -i \
            -e ORDER_BASE_URL \
            -e PAYMENT_BASE_URL \
            -e API_VERSION \
            -e VUS \
            -e ITERATIONS \
            -e MAX_DURATION \
            -e INCLUDE_PAYMENT_INTENT \
            -e CHECKOUT_P95_MS \
            -e CHECKOUT_FAIL_RATE_MAX \
            -e CHECKOUT_SUCCESS_MIN \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            grafana/k6 run ecom-back/load-tests/k6/checkout-flow.js

      - name: Production load regression summary
        if: always()
        run: |
          {
            echo "## Production Load Regression Gate"
            echo ""
            echo "- Read-heavy profile executed for browse/cart and conservative checkout profile."
            echo "- Separate production budgets are enforced."
          } >> "$GITHUB_STEP_SUMMARY"
