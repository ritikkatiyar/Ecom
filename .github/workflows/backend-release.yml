name: backend-release

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    tags: [ "v*" ]

concurrency:
  group: backend-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build shared modules
        run: |
          mvn -f ecom-back/common/common-core/pom.xml -DskipTests install
          mvn -f ecom-back/common/common-events/pom.xml -DskipTests install
          mvn -f ecom-back/common/common-security/pom.xml -DskipTests install

      - name: Quality test gate
        run: |
          mvn -f ecom-back/services/payment-service/pom.xml test
          mvn -f ecom-back/services/inventory-service/pom.xml test
          mvn -f ecom-back/services/search-service/pom.xml test
          mvn -f ecom-back/api-gateway/pom.xml test
          python ecom-back/scripts/check_search_dataset_freshness.py
          python ecom-back/scripts/check_api_docs.py

  package:
    runs-on: ubuntu-latest
    needs: [ quality ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build deployable artifacts
        run: mvn -f ecom-back/pom.xml -DskipTests package

      - name: Create release manifest
        run: |
          mkdir -p build-artifacts
          find ecom-back -name "*.jar" -type f -print > build-artifacts/artifacts.txt
          sha256sum $(cat build-artifacts/artifacts.txt) > build-artifacts/checksums.sha256

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-release-artifacts
          path: |
            build-artifacts/artifacts.txt
            build-artifacts/checksums.sha256
            ecom-back/**/target/*.jar

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [ package ]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-release-artifacts
          path: build-artifacts

      - name: Validate promotion manifest
        run: |
          test -f build-artifacts/artifacts.txt
          test -f build-artifacts/checksums.sha256

      - name: Trigger staging deployment
        env:
          STAGING_DEPLOY_WEBHOOK: ${{ secrets.STAGING_DEPLOY_WEBHOOK }}
        run: |
          if [ -z "$STAGING_DEPLOY_WEBHOOK" ]; then
            echo "STAGING_DEPLOY_WEBHOOK not configured; running dry-run deployment gate."
            exit 0
          fi
          curl -sS -X POST "$STAGING_DEPLOY_WEBHOOK" -H "Content-Type: application/json" -d '{"service":"ecom-backend","ref":"'"${GITHUB_REF}"'"}'

      - name: Run staging smoke checks
        id: smoke_staging
        continue-on-error: true
        env:
          SMOKE_URLS: ${{ secrets.STAGING_SMOKE_URLS }}
          SMOKE_TIMEOUT_SECONDS: 5
          SMOKE_EXPECTED_STATUS: 200
          SMOKE_BEARER_TOKEN: ${{ secrets.STAGING_SMOKE_BEARER_TOKEN }}
        run: |
          if [ -z "$SMOKE_URLS" ]; then
            echo "STAGING_SMOKE_URLS not configured; failing staging smoke gate."
            exit 1
          fi
          python ecom-back/scripts/post_deploy_smoke.py

      - name: Trigger staging rollback on smoke failure
        if: steps.smoke_staging.outcome == 'failure'
        env:
          ROLLBACK_WEBHOOK_URL: ${{ secrets.STAGING_ROLLBACK_WEBHOOK }}
          ROLLBACK_ENVIRONMENT: staging
          ROLLBACK_REASON: post_deploy_smoke_failed
          ROLLBACK_REF: ${{ github.ref }}
          ROLLBACK_RUN_ID: ${{ github.run_id }}
        run: |
          if [ -z "$ROLLBACK_WEBHOOK_URL" ]; then
            echo "STAGING_ROLLBACK_WEBHOOK not configured; cannot auto-rollback."
            exit 1
          fi
          python ecom-back/scripts/trigger_rollback.py

      - name: Enforce staging smoke gate
        if: steps.smoke_staging.outcome == 'failure'
        run: |
          echo "Staging smoke checks failed and rollback was triggered."
          exit 1

  deploy-production:
    runs-on: ubuntu-latest
    needs: [ deploy-staging ]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-release-artifacts
          path: build-artifacts

      - name: Validate production promotion manifest
        run: |
          test -f build-artifacts/artifacts.txt
          test -f build-artifacts/checksums.sha256

      - name: Trigger production deployment
        env:
          PRODUCTION_DEPLOY_WEBHOOK: ${{ secrets.PRODUCTION_DEPLOY_WEBHOOK }}
        run: |
          if [ -z "$PRODUCTION_DEPLOY_WEBHOOK" ]; then
            echo "PRODUCTION_DEPLOY_WEBHOOK not configured; refusing production deploy."
            exit 1
          fi
          curl -sS -X POST "$PRODUCTION_DEPLOY_WEBHOOK" -H "Content-Type: application/json" -d '{"service":"ecom-backend","ref":"'"${GITHUB_REF}"'"}'

      - name: Run production smoke checks
        id: smoke_production
        continue-on-error: true
        env:
          SMOKE_URLS: ${{ secrets.PRODUCTION_SMOKE_URLS }}
          SMOKE_TIMEOUT_SECONDS: 5
          SMOKE_EXPECTED_STATUS: 200
          SMOKE_BEARER_TOKEN: ${{ secrets.PRODUCTION_SMOKE_BEARER_TOKEN }}
        run: |
          if [ -z "$SMOKE_URLS" ]; then
            echo "PRODUCTION_SMOKE_URLS not configured; failing production smoke gate."
            exit 1
          fi
          python ecom-back/scripts/post_deploy_smoke.py

      - name: Trigger production rollback on smoke failure
        if: steps.smoke_production.outcome == 'failure'
        env:
          ROLLBACK_WEBHOOK_URL: ${{ secrets.PRODUCTION_ROLLBACK_WEBHOOK }}
          ROLLBACK_ENVIRONMENT: production
          ROLLBACK_REASON: post_deploy_smoke_failed
          ROLLBACK_REF: ${{ github.ref }}
          ROLLBACK_RUN_ID: ${{ github.run_id }}
        run: |
          if [ -z "$ROLLBACK_WEBHOOK_URL" ]; then
            echo "PRODUCTION_ROLLBACK_WEBHOOK not configured; cannot auto-rollback."
            exit 1
          fi
          python ecom-back/scripts/trigger_rollback.py

      - name: Enforce production smoke gate
        if: steps.smoke_production.outcome == 'failure'
        run: |
          echo "Production smoke checks failed and rollback was triggered."
          exit 1
