# Service Detailed Progress

Last updated: 2026-02-21

## Change Log (Dated)
- 2026-02-14: Added gateway standardized JSON error payloads and route policy tuning.
- 2026-02-14: Added gateway route-level circuit breaker with fallback endpoints and Resilience4j policies.
- 2026-02-14: Added search relevance target threshold evaluation and expanded calibration dataset.
- 2026-02-19: Added search relevance dataset health endpoint and contract/unit tests for evaluation + refresh cadence workflow.
- 2026-02-14: Tuned notification alert thresholds in Prometheus and Grafana.
- 2026-02-14: Added scheduled outbox/dedup cleanup automation across order/payment/inventory/notification/search services.
- 2026-02-14: Expanded observability baseline with Prometheus + Zipkin tracing dependencies and trace-log correlation config across active services.
- 2026-02-19: Added search dataset refresh-health workflow + contract/unit tests and wired Prometheus to Alertmanager with an alert drill runbook.
- 2026-02-19: Added inventory reservation expiry scheduler + concurrency contract tests and established `API_DOCS.md` files in each service/gateway.
- 2026-02-19: Added API gateway edge-route contract tests (version guard, JWT public/protected route policy, fallback payload contract).
- 2026-02-19: Added CI quality workflow (`backend-quality.yml`) with service test gates, search dataset freshness check, and API docs structure validation.
- 2026-02-19: Added inventory integration tests with Testcontainers (real MySQL + Kafka) for contention and consumer dedup scenarios; fixed inventory outbox payload DDL to MySQL-safe `TEXT`.
- 2026-02-19: Added payment webhook HMAC signature verification and failure-injection tests (missing/invalid signature and malformed payload).
- 2026-02-19: Added staged backend release pipeline (`backend-release.yml`) with promotion gates for staging/production environments and artifact manifest validation.
- 2026-02-19: Added flash-sale k6 load-test suite with SLO gates (`p95`, success-rate, server-error-rate, oversell invariant) and PowerShell runner.
- 2026-02-19: Added payment provider outage drill support with retry-to-DLQ flow, dead-letter requeue endpoints, outage toggle APIs, and observability counters.
- 2026-02-19: Added post-deploy smoke-check and rollback trigger automation to release pipeline, plus deploy runbook (`DEPLOY_SMOKE_ROLLBACK.md`).
- 2026-02-19: Added baseline k6 suites for browse/cart/checkout with defined performance budgets and unified runner script.
- 2026-02-19: Added payment outage alert rules and Alertmanager payment receiver routing, with dedicated outage drill runbook (`PAYMENT_OUTAGE_DRILL.md`).
- 2026-02-19: Added rollback verification callbacks and release-gate reporting (workflow summaries + downloadable JSON artifacts).
- 2026-02-19: Added CI-triggered staging load-regression gate with budget pass/fail for browse/cart/checkout k6 suites.
- 2026-02-19: Added search dataset reviewer rotation automation with weekly cadence workflow and due-review issue assignment.
- 2026-02-19: Added Grafana release-gate dashboard panels for rollback callback telemetry (`ecom-release-gate-observability`).
- 2026-02-19: Added production-aware load regression job (`load-regression-production-read-heavy`) with separate read-heavy budgets.
- 2026-02-19: Added search rota multi-reviewer onboarding support (`SEARCH_DATASET_REVIEWERS`) and auto-close policy for due-review issues when cadence is healthy.
- 2026-02-19: Added API gateway internal rollback-callback metrics endpoint and wired release callback script/workflow optional metrics posting (`CALLBACK_METRICS_URL`).
- 2026-02-19: Added weekly production load-budget calibration workflow (`load-budget-calibration.yml`) with report artifacts from `calibrate_load_budgets.py`.
- 2026-02-19: Added search reviewer-pool minimum-size policy and collaborator permission validation in `search-dataset-rota.yml`, plus dedup/health fields in `assign_search_dataset_reviewer.py`.
- 2026-02-19: Calibrated release-gate rollback alerts in Prometheus (failure presence/failure rate/drill-missing), tuned Grafana failure panel window/thresholds, and updated rollback runbook baseline thresholds.
- 2026-02-19: Added Prometheus auto-ingestion for weekly load budget calibration (`fetch_load_telemetry_from_prometheus.py`) and wired resolved `OBSERVED_*` env export into `load-budget-calibration.yml`.
- 2026-02-19: Added weekly ops receiver drill cadence via `ops-receiver-drill.yml` and `run_ops_receiver_drill.py` (config validation + synthetic warning/critical route test + drill artifacts).
- 2026-02-19: Added release-gate drill outcome evaluator (`evaluate_release_gate_drills.py`) and runbook delta-log template for staged/prod rollback threshold tuning capture.
- 2026-02-19: Applied approved production load calibration deltas to release workflow budgets (`backend-release.yml`): browse p95 `276`, cart p95 `312`, checkout p95 `432`.
- 2026-02-19: Added production receiver config validator (`validate_alertmanager_receivers.py`) and wired it into `ops-receiver-drill.yml` as a hard pre-drill gate with artifacted validation report.
- 2026-02-19: Added release readiness checklist gate (`release-readiness-checklist.yml`) and `check_release_readiness.py` to enforce drill/calibration artifact evidence before readiness signoff.
- 2026-02-19: Added scheduled staged/prod release-gate drill workflow (`release-gate-drill.yml`) with `run_release_gate_drill.py` and auto-generated delta reports for runbook tuning capture.
- 2026-02-19: Implemented user-service profile/address/preferences APIs with MySQL entities/repositories, DIP-aligned `UserUseCases`, and OpenAPI/observability baseline wiring.
- 2026-02-19: Implemented review-service review/rating CRUD and moderation APIs with MySQL entity/repository model, `ReviewUseCases` DIP boundary, and OpenAPI/observability baseline wiring.
- 2026-02-19: Added automated release-gate drill log recorder (`record_release_gate_drill_log.py`) and wired `release-gate-drill.yml` to publish persistent delta-log rows (`release-gate-drill-log.md`).
- 2026-02-19: Refactored cart-service for SOLID/SRP by splitting ownership resolution and guest/user storage responsibilities (`CartOwnerResolver`, `GuestCartStore`, `UserCartStore`) and switching controller dependency to `CartUseCases`.
- 2026-02-19: Refactored order-service for SOLID/SRP by extracting item serialization (`OrderItemCodec`), response mapping (`OrderResponseMapper`), and outbox event publishing (`OrderEventPublisher`) from `OrderService`.
- 2026-02-20: Refactored payment-service for SOLID/SRP by extracting provider retry+DLQ allocation (`ProviderPaymentIdAllocator`), outbox event publication (`PaymentResultPublisher`), and DTO mapping (`PaymentResponseMapper`) from `PaymentService`.
- 2026-02-20: Refactored auth-service for SOLID/SRP by introducing `AuthUseCases` and extracting token issuance/generation into `AuthTokenIssuer` and `RefreshTokenGenerator`.
- 2026-02-20: Refactored API gateway JWT guard for SRP by extracting route policy (`GatewayAuthRoutePolicy`) and auth validation client (`AuthValidationClient`) from `JwtAuthFilter`.
- 2026-02-20: Added event contract governance baseline via `contracts/events/event-contracts.json`, per-event schema files, and CI validator script `check_event_contracts.py` wired into `backend-quality.yml` and `backend-release.yml`.
- 2026-02-20: Added release-gate drill evidence enforcement via `check_release_gate_drill_evidence.py` and wired it into `release-gate-drill.yml` to fail when staged/prod evidence is still `missing` or `attention_required`.
- 2026-02-21: Scaffolded Next.js storefront (`ecom-storefront`) with App Router, stitch design system (Voluspa style), routes (home/shop/products/search/cart/account/collections), Header nav, API proxy to gateway. Deprecated `ecom-frontend` (Vite).
- 2026-02-21: Phase 1 core infrastructure: apiClient (X-API-Version, X-Correlation-Id, Auth header, 401 refresh retry, GET retry), AuthContext (JWT decode, roles, login/signup/logout, sessionStorage), AccountGuard/AdminGuard, React Query provider, login/signup/unauthorized pages, route groups (account), (admin).
- 2026-02-21: Admin console: AdminSidebar (stitch design), admin dashboard, Products CRUD (list/create/edit), ProductForm, product API proxy (route handlers), login redirects admins to /admin/dashboard. No separate admin login.
- 2026-02-21: Product service: Cloudinary image upload integration (`POST /api/products/images`), Product `imageUrls` field, conditional Cloudinary beans when `cloudinary.cloud-name` set. Admin ProductForm image picker (upload to Cloudinary, preview, remove). `lib/api/products.ts` and `/api/products/images` proxy.
- 2026-02-21: Added generic Redis fallback (`common-redis`): `RedisFallbackOperations` for graceful degradation when Redis unavailable. Auth-service token blacklist uses fallback (assume not blacklisted on Redis error).
- 2026-02-21: Added request logging in every API: gateway `RequestLoggingFilter` (method, path, status, duration, correlation-id, client IP); `common-web` with shared filter for backend services (auth, cart, product, inventory, order, payment, user, review, search, notification).
- 2026-02-21: Gateway: FallbackController supports all HTTP methods (GET, POST, etc.); auth-circuit timeout 15s; AuthValidationClient configurable validate-timeout (15s); JwtAuthFilter logs 401 AUTH_TOKEN_MISSING/INVALID and 503 AUTH_VALIDATION_UNAVAILABLE.
- 2026-02-21: Product service: multipart max 10MB per file/request; `ApiExceptionLoggingAdvice` logs 400 multipart and missing-param; ImageUploadController logs fileCount/urlCount.
- 2026-02-21: Frontend: `uploadProductImages` uses `fetchWithAuthRetry` for 401 retry with token refresh; adds X-Correlation-Id to upload requests.

## Frontend / Storefront (`ecom-storefront`)
- Stack:
  - Next.js 15 (App Router), TypeScript, Tailwind CSS v4
  - Newsreader + Inter fonts, Material Symbols icons
  - @tanstack/react-query (staleTime, retry policy)
  - apiClient: X-API-Version, X-Correlation-Id, Bearer token, 401 refresh retry, GET retry; fetchWithAuthRetry for image upload (401 retry + X-Correlation-Id)
  - AuthContext: JWT decode, roles (USER, ADMIN), login/signup/logout
  - Route guards: AccountGuard (/account), AdminGuard (/admin)
- Routes:
  - `/` – Home
  - `/shop` – Product listing
  - `/products/[id]` – Product detail (stitch PDP)
  - `/search` – Search
  - `/cart` – Cart
  - `/checkout` – Checkout (placeholder)
  - `/login`, `/signup` – Auth
  - `/account` – Account (USER/ADMIN, guarded)
  - `/admin/dashboard` – Admin dashboard
  - `/admin/products` – Product list
  - `/admin/products/new` – Create product
  - `/admin/products/[id]/edit` – Edit product
  - `/admin/orders` – Orders (placeholder)
  - `/unauthorized` – Insufficient role
  - `/collections` – Collections
- Design (stitch):
  - Primary `#2badee`, background `#F8F6F3`, ivory `#EFEBE7`
  - Design source: `stitch/voluspa_product_page_1`, `stitch/admin_dashboard`, `stitch/user_account_page`
- Config:
  - `NEXT_PUBLIC_BACKEND_URL` – API Gateway URL (default `http://localhost:8080`)
  - Next.js rewrites `/api/*` to backend gateway
- Verification:
  - `npm run dev` starts at `http://localhost:3000`
- Pending:
  - Wire products API for storefront browse/search (admin CRUD + image upload done)
  - Wire search API (`GET /api/search/products`)
  - Wire cart API (`GET/POST /api/cart`, `POST /api/cart/items`, etc.)
  - Wire auth API (`POST /api/auth/signup`, `/login`, etc.)
  - Add feature flags (beta banner, admin console) from gateway `/internal/frontend-flags`
  - Add state management (React Query/SWR) and optimistic cart

## API Gateway (`ecom-back/api-gateway`)
- APIs:
  - Route forwarding for `/api/auth`, `/api/products`, `/api/inventory`, `/api/cart`, `/api/orders`, `/api/payments`, `/api/search`.
- Kafka in/out:
  - None.
- Data model:
  - None.
- Patterns:
  - API gateway route aggregation.
  - Request logging on every API call (method, path, status, duration, correlation-id, client IP).
  - Global correlation ID propagation (`X-Correlation-Id`).
  - API version guard (`X-API-Version: v1` for non-auth `/api/**` calls).
  - Per-IP rate limiting with Redis + in-memory fallback (`RateLimitWithFallbackFilter`).
  - JWT validation filter via auth-service `/api/auth/validate`.
  - Standardized JSON error payloads across auth/version/rate-limit filters.
  - Route policy tuning: read-only product/search APIs are public, write paths remain protected.
  - Route-level circuit breakers with fallback responses (`/fallback/{service}`).
  - SRP split: `JwtAuthFilter` orchestration with `GatewayAuthRoutePolicy` and `AuthValidationClient` collaborators.
  - Resilience4j circuit breaker and time limiter baseline configuration.
  - Internal release-gate callback metrics ingestion endpoint (`POST /internal/release-gate/callbacks`) for Prometheus-scraped rollback callback counters.
  - Zipkin tracing export and trace-log correlation pattern (`traceId`, `spanId`).
- Verification:
  - `api-gateway` tests pass for version-guard, JWT route policy, and fallback contract behavior.
- Pending:
  - Breaker-threshold tuning and callback metric alert calibration under drill traffic.

## Observability Infra (`ecom-back/infrastructure`)
- Components:
  - Prometheus alerting now routes to Alertmanager (`prometheus.yml` -> `alertmanagers` block).
  - Alertmanager config added in `alertmanager/alertmanager.yml`.
  - Docker compose includes `alertmanager` service on `:9093`.
  - Drill runbook added: `runbooks/ALERT_DRILL.md`.
  - Payment-specific alert rules added (`PaymentProviderRetrySpike`, `PaymentProviderDlqIncrease`, `PaymentProviderRequeueFailures`).
  - Alertmanager routing/receivers extended for `payment-service` warning and critical paths.
  - Payment drill runbook added: `runbooks/PAYMENT_OUTAGE_DRILL.md`.
  - Release-gate telemetry dashboard added: `grafana/dashboards/release-gate-observability.json`.
  - Release-gate alert calibration added in `prometheus/alerts.yml`:
    - `ReleaseGateRollbackCallbackFailuresPresent` (>=1 failure in 6h, warning)
    - `ReleaseGateRollbackCallbackFailureRateCritical` (>20% in 24h with >=3 events, critical)
    - `ReleaseGateRollbackCallbackDrillMissing` (<1 callback event over 14d, warning)
  - Weekly receiver drill runbook/workflow integration:
    - `runbooks/ALERT_DRILL.md` cadence section
    - `.github/workflows/ops-receiver-drill.yml`
    - `scripts/run_ops_receiver_drill.py`
    - `scripts/validate_alertmanager_receivers.py` (placeholder/malformed config blocker)
- Pending:
  - Replace placeholder webhook receivers with production integrations (Slack/PagerDuty/email) and validate calibrated rollback callback thresholds against live drill noise.

## Shared Modules (`ecom-back/common`)
- **common-redis**: Generic Redis fallback for graceful degradation. `RedisFallbackOperations` catches Redis errors and returns safe defaults. Used by auth-service token blacklist.
- **common-web**: Shared request logging for Spring MVC services. `RequestLoggingFilter` logs method, path, status, duration, correlation-id, client IP. Auto-configured for all backend services via `common-web` dependency.

## Shared Reliability (`ecom-back/common/common-core`)
- Shared components added:
  - `ConsumerDedupSupport` (generic event dedup helper).
  - `OutboxPublishSupport` (generic outbox retry/publish loop).
  - `EventConsumptionRecord` and `RetryableOutboxRecord` interfaces.
- Adoption:
  - Order/Payment/Inventory outbox publishers migrated.
  - Order/Payment/Inventory/Search/Notification dedup services migrated.
- Verification:
  - `common-core` compiles after extraction.
- Pending:
  - Optional consolidation of service-specific outbox/dedup wrappers into thinner adapters.

## Auth Service (`ecom-back/services/auth-service`)
- APIs:
  - `POST /api/auth/signup`
  - `POST /api/auth/login`
  - `POST /api/auth/refresh`
  - `POST /api/auth/logout`
  - `GET /api/auth/validate`
- Kafka in/out:
  - None.
- Data model:
  - `UserAccount`, `RefreshToken` (MySQL).
  - Access-token blacklist (Redis with `common-redis` fallback when Redis unavailable).
- Patterns:
  - JWT + refresh token.
  - DIP via `AuthUseCases` (`AuthController` and OAuth2 success handler depend on interface).
  - SRP split: `AuthService` orchestration, `AuthTokenIssuer` token issuance/persistence, `RefreshTokenGenerator` secure token generation.
  - Token blacklist.
  - OAuth2 login handler.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Service compiles and runs in local stack.
- Pending:
  - Rotation/audit hardening.
  - Broader integration tests.

## User Service (`ecom-back/services/user-service`)
- APIs:
  - `PUT /api/users/{userId}/profile`
  - `GET /api/users/{userId}/profile`
  - `PUT /api/users/{userId}/preferences`
  - `GET /api/users/{userId}/preferences`
  - `POST /api/users/{userId}/addresses`
  - `GET /api/users/{userId}/addresses`
  - `PUT /api/users/{userId}/addresses/{addressId}`
  - `POST /api/users/{userId}/addresses/{addressId}/default`
  - `DELETE /api/users/{userId}/addresses/{addressId}`
- Kafka in/out:
  - None yet.
- Data model:
  - `UserProfileRecord`, `UserAddressRecord`, `UserPreferencesRecord` (MySQL).
- Patterns:
  - DIP via `UserUseCases`.
  - Address default normalization ensures a single default per user.
  - OpenAPI + Prometheus + Zipkin baseline in service config.
- Verification:
  - `user-service` compiles and tests pass (`mvn -f ecom-back/services/user-service/pom.xml test`).
- Pending:
  - Add integration tests and auth-policy coupling from API gateway/write-path policy.

## Product Service (`ecom-back/services/product-service`)
- APIs:
  - `POST /api/products`
  - `PUT /api/products/{id}`
  - `GET /api/products/{id}`
  - `DELETE /api/products/{id}`
  - `GET /api/products` (pagination/filter/sort/search)
  - `POST /api/products/images` (multipart image upload → Cloudinary)
- Kafka in/out:
  - No producer/consumer implemented yet for product index sync (currently search has direct indexing APIs and optional consumer).
- Data model:
  - `Product` (MongoDB): id, name, description, category, brand, price, active, colors, sizes, imageUrls.
- Patterns:
  - DIP via `ProductUseCases`.
  - OpenAPI + validation.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Compiles.
- Pending:
  - Product upsert/delete event publishing.
  - Variant/ranking-aware modeling enhancements.

## Inventory Service (`ecom-back/services/inventory-service`)
- APIs:
  - `POST /api/inventory/stock`
  - `GET /api/inventory/stock/{sku}`
  - `POST /api/inventory/reserve`
  - `POST /api/inventory/release`
  - `POST /api/inventory/confirm`
- Kafka in:
  - `order.created.v1`
  - `order.timed-out.v1`
  - `payment.authorized.v1`
  - `payment.failed.v1`
- Kafka out:
  - `inventory.reserved.v1`
  - `inventory.reservation.failed.v1`
- Data model:
  - `InventoryStock`, `InventoryReservation` (MySQL).
  - Redis lock for SKU operations.
- Patterns:
  - Lock-based stock reservation.
  - Saga participant with compensation.
  - Deterministic reservation IDs (`orderId:sku`) for reconciliation.
  - Consumer dedup for Kafka events.
  - Outbox publisher for inventory reservation outcome events.
  - Scheduled reliability cleanup for outbox and consumed-event dedup records.
  - Scheduled reservation-expiry sweep releases stale `RESERVED` records.
  - Concurrency contract coverage for idempotent reserve and expiry release behavior.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - `inventory-service` tests pass including reservation expiry/idempotent reservation contracts and Testcontainers integration coverage for Kafka-driven contention + duplicate-event dedup.
  - Flash-sale scenario can be executed via `ecom-back/load-tests/run-flash-sale.ps1`; thresholds fail the run if oversell invariant or latency/error SLOs are violated.
- Pending:
  - Tune flash-sale thresholds per environment and feed results into CI regression gate.

## Load Testing (`ecom-back/load-tests`)
- Suites:
  - `k6/flash-sale-inventory.js`
  - `k6/browse-products.js`
  - `k6/cart-operations.js`
  - `k6/checkout-flow.js`
- Runner scripts:
  - `run-flash-sale.ps1`
  - `run-baseline-suites.ps1`
- Budgets:
  - Browse: p95 `<180ms`, fail rate `<2%`
  - Cart: p95 `<220ms`, fail rate `<3%`, cart consistency `>99%`
  - Checkout: p95 `<320ms`, fail rate `<5%`, checkout success `>95%`
- Pending:
  - Maintain weekly change-review gate ensuring calibration artifacts are attached to each threshold update.
  - Add explicit query overrides for environment-specific URI label patterns if metrics cardinality changes.

## Cart Service (`ecom-back/services/cart-service`)
- APIs:
  - `POST /api/cart/items`
  - `GET /api/cart`
  - `DELETE /api/cart/items/{productId}`
  - `DELETE /api/cart`
  - `POST /api/cart/merge`
- Kafka in/out:
  - None yet.
- Data model:
  - Guest cart in Redis.
  - User cart items in MySQL.
- Patterns:
  - DIP via `CartUseCases` (`CartController` -> interface boundary).
  - SRP split: `CartService` orchestration, `CartOwnerResolver` owner validation, `UserCartStore` MySQL operations, `GuestCartStore` Redis operations/TTL.
  - Guest-to-user merge.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Service and tests compile.
- Pending:
  - Price snapshot validation.
  - Cart event publishing.

## Order Service (`ecom-back/services/order-service`)
- APIs:
  - `POST /api/orders`
  - `GET /api/orders/{orderId}`
  - `GET /api/orders?userId=...`
  - `POST /api/orders/{orderId}/cancel`
  - `POST /api/orders/{orderId}/confirm`
  - `POST /api/orders/admin/saga/timeouts/run`
  - `POST /api/orders/admin/outbox/replay-failed`
- Kafka in:
  - `payment.authorized.v1`
  - `payment.failed.v1`
  - `inventory.reservation.failed.v1`
- Kafka out:
  - `order.created.v1` (via outbox publisher)
  - `order.timed-out.v1` (via outbox publisher)
- Data model:
  - `OrderRecord`, consumed-event dedup table, outbox table (MySQL).
- Patterns:
  - Saga coordinator role for order status.
  - Consumer idempotency.
  - Outbox publisher via dedicated `OrderEventPublisher` component.
  - SRP split: `OrderService` orchestration, `OrderItemCodec` JSON codec, `OrderResponseMapper` DTO mapping.
  - Scheduled reliability cleanup for outbox and consumed-event dedup records.
  - Scheduled timeout sweep for stuck `PAYMENT_PENDING` orders.
  - Manual replay trigger for failed outbox events.
  - Saga observability metrics (`order.saga.timeout.total`, `order.outbox.replay.total`, `order.outbox.failed.records`).
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Compiles after timeout/replay tooling + metrics updates.
- Pending:
  - Alert threshold tuning and runbook-based operational validation.

## Payment Service (`ecom-back/services/payment-service`)
- APIs:
  - `POST /api/payments/intents`
  - `GET /api/payments/{paymentId}`
  - `POST /api/payments/webhook`
  - `GET /api/payments/provider/outage-mode`
  - `POST /api/payments/provider/outage-mode?enabled=...`
  - `GET /api/payments/provider/dead-letters`
  - `POST /api/payments/provider/dead-letters/{id}/requeue`
- Kafka in:
  - `order.created.v1`
- Kafka out:
  - `payment.authorized.v1` (via outbox)
  - `payment.failed.v1` (via outbox)
- Data model:
  - `PaymentRecord`, `WebhookEventRecord`, consumed-event dedup table, outbox table (MySQL).
  - `ProviderDeadLetterRecord` (MySQL) for provider outage retry exhaustion.
- Patterns:
  - Webhook idempotency.
  - HMAC-SHA256 webhook signature verification on raw payload (`X-Razorpay-Signature`).
  - Provider adapter outage-mode toggle for deterministic drills.
  - Retry policy for provider intent creation (`app.payment.provider.max-attempts`) with DLQ fallback via `ProviderPaymentIdAllocator`.
  - Dead-letter requeue workflow for provider recovery.
  - SRP split: `PaymentService` orchestration, `PaymentResultPublisher` Kafka outbox payload publication, `PaymentResponseMapper` DTO mapping.
  - Observability counters: `payment.provider.retry.total`, `payment.provider.dlq.total`, `payment.provider.requeue.total`, `payment.provider.outage.toggle.total`.
  - Consumer idempotency.
  - Outbox publisher.
  - Scheduled reliability cleanup for outbox and consumed-event dedup records.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - `payment-service` tests pass, including controller failure-injection tests, signature verifier unit tests, and provider outage retry/DLQ/requeue unit coverage.
- Pending:
  - Threshold tuning from live drill telemetry and pager noise calibration.

## Review Service (`ecom-back/services/review-service`)
- APIs:
  - `POST /api/reviews`
  - `PUT /api/reviews/{reviewId}`
  - `DELETE /api/reviews/{reviewId}`
  - `GET /api/reviews/{reviewId}`
  - `GET /api/reviews?productId=...&includePending=...`
  - `GET /api/reviews/by-user?userId=...`
  - `POST /api/reviews/{reviewId}/moderate`
- Kafka in/out:
  - None yet.
- Data model:
  - `ReviewRecord` (MySQL), `ReviewStatus` enum (`PENDING`, `APPROVED`, `REJECTED`).
- Patterns:
  - DIP via `ReviewUseCases`.
  - Moderation flow: create/update resets review to `PENDING`.
  - Product listing defaults to approved reviews only (`includePending=false`).
  - OpenAPI + Prometheus + Zipkin baseline in service config.
- Verification:
  - `review-service` compiles and tests pass (`mvn -f ecom-back/services/review-service/pom.xml test`).
- Pending:
  - Add integration tests + gateway auth policy for write/moderation paths.

## Search Service (`ecom-back/services/search-service`)
- APIs:
  - `POST /api/search/index/products`
  - `POST /api/search/index/products/bulk`
  - `DELETE /api/search/index/products/{productId}`
  - `GET /api/search/products` (`activeOnly`, ranking-aware query)
  - `GET /api/search/autocomplete`
  - `POST /api/search/reindex/products`
  - `GET /api/search/admin/relevance/evaluate`
  - `GET /api/search/admin/relevance/dataset/health`
- Kafka in:
  - `product.upserted.v1`
  - `product.deleted.v1`
- Kafka out:
  - None.
- Data model:
  - `SearchProductDocument` (Elasticsearch).
- Patterns:
  - Fuzzy multi-field query.
  - Boosted ranking for exact/phrase-prefix name matches.
  - Active-product filtering by default.
  - Autocomplete query.
  - Service-to-service reindex pull from product-service (paged import).
  - Consumer dedup for product index events.
  - Curated relevance dataset evaluation with configurable pass-rate target (`app.search.relevance.target-pass-rate`) and `meetsTarget` outcome.
  - Scheduled consumed-event dedup cleanup.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- DIP via `SearchUseCases`.
- Verification:
  - `search-service` tests pass for relevance controller contract and dataset health service logic.
- Pending:
  - Reindex integration coverage with seeded elastic documents.
  - Keep reviewer pool ownership mapping aligned with team changes and release calendar.

## Notification Service (`ecom-back/services/notification-service`)
- APIs:
  - `GET /api/notifications?userId=...`
  - `GET /api/notifications/failed`
  - `POST /api/notifications/retry-failed`
  - `GET /api/notifications/dead-letters`
  - `POST /api/notifications/dead-letters/{id}/requeue`
- Kafka in:
  - `order.created.v1`
  - `payment.authorized.v1`
  - `payment.failed.v1`
- Kafka out:
  - `notification.dlq.v1`
  - `notification.alert.v1`
- Data model:
  - `NotificationRecord` (MySQL).
- Patterns:
  - Consumer dedup for notification event listeners.
  - Event idempotency.
  - Scheduled retry for failed deliveries.
  - Config-driven provider abstraction (`log` / `smtp`).
  - Dead-letter escalation on retry exhaustion with requeue workflow.
  - Template-based subject/body rendering from resource dataset.
  - Metrics counters for sent/failed/dead-letter/requeue.
  - Scheduled consumed-event dedup cleanup.
  - Prometheus alert threshold tuning for dead-letter spikes and failure-rate monitoring.
  - Grafana threshold bands for notification dead-letters and failure-rate stat panel.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Compiles after template engine + alert publisher + metrics integration.
- Pending:
  - Production SMTP credential/secrets wiring.
  - Alertmanager receiver routing and on-call runbook drill validation.

## API Docs Convention
- `API_DOCS.md` added in each service folder and in `api-gateway`.
- Rule: update corresponding `API_DOCS.md` whenever endpoint contracts, entities, stores, or async flow change.
- Required sections validated by CI: `Endpoints`, `Entities`, `Data Stores`, `Flow`.



