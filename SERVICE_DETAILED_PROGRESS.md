# Service Detailed Progress

Last updated: 2026-02-19

## Change Log (Dated)
- 2026-02-14: Added gateway standardized JSON error payloads and route policy tuning.
- 2026-02-14: Added gateway route-level circuit breaker with fallback endpoints and Resilience4j policies.
- 2026-02-14: Added search relevance target threshold evaluation and expanded calibration dataset.
- 2026-02-19: Added search relevance dataset health endpoint and contract/unit tests for evaluation + refresh cadence workflow.
- 2026-02-14: Tuned notification alert thresholds in Prometheus and Grafana.
- 2026-02-14: Added scheduled outbox/dedup cleanup automation across order/payment/inventory/notification/search services.
- 2026-02-14: Expanded observability baseline with Prometheus + Zipkin tracing dependencies and trace-log correlation config across active services.
- 2026-02-19: Added search dataset refresh-health workflow + contract/unit tests and wired Prometheus to Alertmanager with an alert drill runbook.
- 2026-02-19: Added inventory reservation expiry scheduler + concurrency contract tests and established `API_DOCS.md` files in each service/gateway.
- 2026-02-19: Added API gateway edge-route contract tests (version guard, JWT public/protected route policy, fallback payload contract).
- 2026-02-19: Added CI quality workflow (`backend-quality.yml`) with service test gates, search dataset freshness check, and API docs structure validation.
- 2026-02-19: Added inventory integration tests with Testcontainers (real MySQL + Kafka) for contention and consumer dedup scenarios; fixed inventory outbox payload DDL to MySQL-safe `TEXT`.
- 2026-02-19: Added payment webhook HMAC signature verification and failure-injection tests (missing/invalid signature and malformed payload).
- 2026-02-19: Added staged backend release pipeline (`backend-release.yml`) with promotion gates for staging/production environments and artifact manifest validation.
- 2026-02-19: Added flash-sale k6 load-test suite with SLO gates (`p95`, success-rate, server-error-rate, oversell invariant) and PowerShell runner.
- 2026-02-19: Added payment provider outage drill support with retry-to-DLQ flow, dead-letter requeue endpoints, outage toggle APIs, and observability counters.
- 2026-02-19: Added post-deploy smoke-check and rollback trigger automation to release pipeline, plus deploy runbook (`DEPLOY_SMOKE_ROLLBACK.md`).
- 2026-02-19: Added baseline k6 suites for browse/cart/checkout with defined performance budgets and unified runner script.
- 2026-02-19: Added payment outage alert rules and Alertmanager payment receiver routing, with dedicated outage drill runbook (`PAYMENT_OUTAGE_DRILL.md`).

## API Gateway (`ecom-back/api-gateway`)
- APIs:
  - Route forwarding for `/api/auth`, `/api/products`, `/api/inventory`, `/api/cart`, `/api/orders`, `/api/payments`, `/api/search`.
- Kafka in/out:
  - None.
- Data model:
  - None.
- Patterns:
  - API gateway route aggregation.
  - Global correlation ID propagation (`X-Correlation-Id`).
  - API version guard (`X-API-Version: v1` for non-auth `/api/**` calls).
  - Distributed Redis-backed per-IP route-level rate limiting (`RequestRateLimiter` + `ipKeyResolver`).
  - JWT validation filter via auth-service `/api/auth/validate`.
  - Standardized JSON error payloads across auth/version/rate-limit filters.
  - Route policy tuning: read-only product/search APIs are public, write paths remain protected.
  - Route-level circuit breakers with fallback responses (`/fallback/{service}`).
  - Resilience4j circuit breaker and time limiter baseline configuration.
  - Zipkin tracing export and trace-log correlation pattern (`traceId`, `spanId`).
- Verification:
  - `api-gateway` tests pass for version-guard, JWT route policy, and fallback contract behavior.
- Pending:
  - Edge-route contract tests for public/protected behavior.

## Observability Infra (`ecom-back/infrastructure`)
- Components:
  - Prometheus alerting now routes to Alertmanager (`prometheus.yml` -> `alertmanagers` block).
  - Alertmanager config added in `alertmanager/alertmanager.yml`.
  - Docker compose includes `alertmanager` service on `:9093`.
  - Drill runbook added: `runbooks/ALERT_DRILL.md`.
  - Payment-specific alert rules added (`PaymentProviderRetrySpike`, `PaymentProviderDlqIncrease`, `PaymentProviderRequeueFailures`).
  - Alertmanager routing/receivers extended for `payment-service` warning and critical paths.
  - Payment drill runbook added: `runbooks/PAYMENT_OUTAGE_DRILL.md`.
- Pending:
  - Replace placeholder webhook receivers with production integrations (Slack/PagerDuty/email) and validate rollback callback telemetry.

## Shared Reliability (`ecom-back/common/common-core`)
- Shared components added:
  - `ConsumerDedupSupport` (generic event dedup helper).
  - `OutboxPublishSupport` (generic outbox retry/publish loop).
  - `EventConsumptionRecord` and `RetryableOutboxRecord` interfaces.
- Adoption:
  - Order/Payment/Inventory outbox publishers migrated.
  - Order/Payment/Inventory/Search/Notification dedup services migrated.
- Verification:
  - `common-core` compiles after extraction.
- Pending:
  - Optional consolidation of service-specific outbox/dedup wrappers into thinner adapters.

## Auth Service (`ecom-back/services/auth-service`)
- APIs:
  - `POST /api/auth/signup`
  - `POST /api/auth/login`
  - `POST /api/auth/refresh`
  - `POST /api/auth/logout`
  - `GET /api/auth/validate`
- Kafka in/out:
  - None.
- Data model:
  - `UserAccount`, `RefreshToken` (MySQL).
  - Access-token blacklist (Redis).
- Patterns:
  - JWT + refresh token.
  - Token blacklist.
  - OAuth2 login handler.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Service compiles and runs in local stack.
- Pending:
  - Rotation/audit hardening.
  - Broader integration tests.

## User Service (`ecom-back/services/user-service`)
- APIs:
  - Health only.
- Kafka in/out:
  - None.
- Data model:
  - Not implemented.
- Patterns:
  - Scaffold only.
- Verification:
  - Module scaffold exists.
- Pending:
  - Full profile/address/preferences implementation.

## Product Service (`ecom-back/services/product-service`)
- APIs:
  - `POST /api/products`
  - `PUT /api/products/{id}`
  - `GET /api/products/{id}`
  - `DELETE /api/products/{id}`
  - `GET /api/products` (pagination/filter/sort/search)
- Kafka in/out:
  - No producer/consumer implemented yet for product index sync (currently search has direct indexing APIs and optional consumer).
- Data model:
  - `Product` (MongoDB).
- Patterns:
  - DIP via `ProductUseCases`.
  - OpenAPI + validation.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Compiles.
- Pending:
  - Product upsert/delete event publishing.
  - Variant/ranking-aware modeling enhancements.

## Inventory Service (`ecom-back/services/inventory-service`)
- APIs:
  - `POST /api/inventory/stock`
  - `GET /api/inventory/stock/{sku}`
  - `POST /api/inventory/reserve`
  - `POST /api/inventory/release`
  - `POST /api/inventory/confirm`
- Kafka in:
  - `order.created.v1`
  - `order.timed-out.v1`
  - `payment.authorized.v1`
  - `payment.failed.v1`
- Kafka out:
  - `inventory.reserved.v1`
  - `inventory.reservation.failed.v1`
- Data model:
  - `InventoryStock`, `InventoryReservation` (MySQL).
  - Redis lock for SKU operations.
- Patterns:
  - Lock-based stock reservation.
  - Saga participant with compensation.
  - Deterministic reservation IDs (`orderId:sku`) for reconciliation.
  - Consumer dedup for Kafka events.
  - Outbox publisher for inventory reservation outcome events.
  - Scheduled reliability cleanup for outbox and consumed-event dedup records.
  - Scheduled reservation-expiry sweep releases stale `RESERVED` records.
  - Concurrency contract coverage for idempotent reserve and expiry release behavior.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - `inventory-service` tests pass including reservation expiry/idempotent reservation contracts and Testcontainers integration coverage for Kafka-driven contention + duplicate-event dedup.
  - Flash-sale scenario can be executed via `ecom-back/load-tests/run-flash-sale.ps1`; thresholds fail the run if oversell invariant or latency/error SLOs are violated.
- Pending:
  - Tune flash-sale thresholds per environment and feed results into CI regression gate.

## Load Testing (`ecom-back/load-tests`)
- Suites:
  - `k6/flash-sale-inventory.js`
  - `k6/browse-products.js`
  - `k6/cart-operations.js`
  - `k6/checkout-flow.js`
- Runner scripts:
  - `run-flash-sale.ps1`
  - `run-baseline-suites.ps1`
- Budgets:
  - Browse: p95 `<180ms`, fail rate `<2%`
  - Cart: p95 `<220ms`, fail rate `<3%`, cart consistency `>99%`
  - Checkout: p95 `<320ms`, fail rate `<5%`, checkout success `>95%`
- Pending:
  - Add CI pipeline stage to run selected suites and block regressions on threshold violations.

## Cart Service (`ecom-back/services/cart-service`)
- APIs:
  - `POST /api/cart/items`
  - `GET /api/cart`
  - `DELETE /api/cart/items/{productId}`
  - `DELETE /api/cart`
  - `POST /api/cart/merge`
- Kafka in/out:
  - None yet.
- Data model:
  - Guest cart in Redis.
  - User cart items in MySQL.
- Patterns:
  - Guest-to-user merge.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Service and tests compile.
- Pending:
  - Price snapshot validation.
  - Cart event publishing.

## Order Service (`ecom-back/services/order-service`)
- APIs:
  - `POST /api/orders`
  - `GET /api/orders/{orderId}`
  - `GET /api/orders?userId=...`
  - `POST /api/orders/{orderId}/cancel`
  - `POST /api/orders/{orderId}/confirm`
  - `POST /api/orders/admin/saga/timeouts/run`
  - `POST /api/orders/admin/outbox/replay-failed`
- Kafka in:
  - `payment.authorized.v1`
  - `payment.failed.v1`
  - `inventory.reservation.failed.v1`
- Kafka out:
  - `order.created.v1` (via outbox publisher)
  - `order.timed-out.v1` (via outbox publisher)
- Data model:
  - `OrderRecord`, consumed-event dedup table, outbox table (MySQL).
- Patterns:
  - Saga coordinator role for order status.
  - Consumer idempotency.
  - Outbox publisher.
  - Scheduled reliability cleanup for outbox and consumed-event dedup records.
  - Scheduled timeout sweep for stuck `PAYMENT_PENDING` orders.
  - Manual replay trigger for failed outbox events.
  - Saga observability metrics (`order.saga.timeout.total`, `order.outbox.replay.total`, `order.outbox.failed.records`).
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Compiles after timeout/replay tooling + metrics updates.
- Pending:
  - Alert threshold tuning and runbook-based operational validation.

## Payment Service (`ecom-back/services/payment-service`)
- APIs:
  - `POST /api/payments/intents`
  - `GET /api/payments/{paymentId}`
  - `POST /api/payments/webhook`
  - `GET /api/payments/provider/outage-mode`
  - `POST /api/payments/provider/outage-mode?enabled=...`
  - `GET /api/payments/provider/dead-letters`
  - `POST /api/payments/provider/dead-letters/{id}/requeue`
- Kafka in:
  - `order.created.v1`
- Kafka out:
  - `payment.authorized.v1` (via outbox)
  - `payment.failed.v1` (via outbox)
- Data model:
  - `PaymentRecord`, `WebhookEventRecord`, consumed-event dedup table, outbox table (MySQL).
  - `ProviderDeadLetterRecord` (MySQL) for provider outage retry exhaustion.
- Patterns:
  - Webhook idempotency.
  - HMAC-SHA256 webhook signature verification on raw payload (`X-Razorpay-Signature`).
  - Provider adapter outage-mode toggle for deterministic drills.
  - Retry policy for provider intent creation (`app.payment.provider.max-attempts`) with DLQ fallback.
  - Dead-letter requeue workflow for provider recovery.
  - Observability counters: `payment.provider.retry.total`, `payment.provider.dlq.total`, `payment.provider.requeue.total`, `payment.provider.outage.toggle.total`.
  - Consumer idempotency.
  - Outbox publisher.
  - Scheduled reliability cleanup for outbox and consumed-event dedup records.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - `payment-service` tests pass, including controller failure-injection tests, signature verifier unit tests, and provider outage retry/DLQ/requeue unit coverage.
- Pending:
  - Threshold tuning from live drill telemetry and pager noise calibration.

## Review Service (`ecom-back/services/review-service`)
- APIs:
  - Health only.
- Kafka in/out:
  - None.
- Data model:
  - Not implemented.
- Patterns:
  - Scaffold only.
- Verification:
  - Module scaffold exists.
- Pending:
  - CRUD and moderation implementation.

## Search Service (`ecom-back/services/search-service`)
- APIs:
  - `POST /api/search/index/products`
  - `POST /api/search/index/products/bulk`
  - `DELETE /api/search/index/products/{productId}`
  - `GET /api/search/products` (`activeOnly`, ranking-aware query)
  - `GET /api/search/autocomplete`
  - `POST /api/search/reindex/products`
  - `GET /api/search/admin/relevance/evaluate`
  - `GET /api/search/admin/relevance/dataset/health`
- Kafka in:
  - `product.upserted.v1`
  - `product.deleted.v1`
- Kafka out:
  - None.
- Data model:
  - `SearchProductDocument` (Elasticsearch).
- Patterns:
  - Fuzzy multi-field query.
  - Boosted ranking for exact/phrase-prefix name matches.
  - Active-product filtering by default.
  - Autocomplete query.
  - Service-to-service reindex pull from product-service (paged import).
  - Consumer dedup for product index events.
  - Curated relevance dataset evaluation with configurable pass-rate target (`app.search.relevance.target-pass-rate`) and `meetsTarget` outcome.
  - Scheduled consumed-event dedup cleanup.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- DIP via `SearchUseCases`.
- Verification:
  - `search-service` tests pass for relevance controller contract and dataset health service logic.
- Pending:
  - Reindex integration coverage with seeded elastic documents.
  - Dataset refresh cadence ownership + baseline quality gate in CI.

## Notification Service (`ecom-back/services/notification-service`)
- APIs:
  - `GET /api/notifications?userId=...`
  - `GET /api/notifications/failed`
  - `POST /api/notifications/retry-failed`
  - `GET /api/notifications/dead-letters`
  - `POST /api/notifications/dead-letters/{id}/requeue`
- Kafka in:
  - `order.created.v1`
  - `payment.authorized.v1`
  - `payment.failed.v1`
- Kafka out:
  - `notification.dlq.v1`
  - `notification.alert.v1`
- Data model:
  - `NotificationRecord` (MySQL).
- Patterns:
  - Consumer dedup for notification event listeners.
  - Event idempotency.
  - Scheduled retry for failed deliveries.
  - Config-driven provider abstraction (`log` / `smtp`).
  - Dead-letter escalation on retry exhaustion with requeue workflow.
  - Template-based subject/body rendering from resource dataset.
  - Metrics counters for sent/failed/dead-letter/requeue.
  - Scheduled consumed-event dedup cleanup.
  - Prometheus alert threshold tuning for dead-letter spikes and failure-rate monitoring.
  - Grafana threshold bands for notification dead-letters and failure-rate stat panel.
  - Prometheus metrics export + Zipkin tracing baseline and trace-log correlation.
- Verification:
  - Compiles after template engine + alert publisher + metrics integration.
- Pending:
  - Production SMTP credential/secrets wiring.
  - Alertmanager receiver routing and on-call runbook drill validation.

## API Docs Convention
- `API_DOCS.md` added in each service folder and in `api-gateway`.
- Rule: update corresponding `API_DOCS.md` whenever endpoint contracts, entities, stores, or async flow change.
- Required sections validated by CI: `Endpoints`, `Entities`, `Data Stores`, `Flow`.
